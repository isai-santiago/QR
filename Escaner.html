<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profesor Dashboard</title>
    <script src="html5-qrcode.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f2f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        
        /* √Årea del Esc√°ner */
        #reader { width: 100%; border-radius: 8px; overflow: hidden; background: black; }
        
        /* Alertas [US-03] */
        .alert { padding: 15px; margin: 10px 0; border-radius: 5px; text-align: center; display: none; font-weight: bold; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* Tabla Dashboard [US-08] */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #007bff; color: white; }
        tr:nth-child(even) { background: #f9f9f9; }

        .btn-danger { background: #dc3545; color: white; border: none; padding: 10px; cursor: pointer; border-radius: 5px; float: right; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Panel de Asistencia</h1>
        
        <div id="reader"></div>
        <div id="statusMsg" class="alert"></div>

        <div style="margin-top: 30px; display: flex; justify-content: space-between; align-items: center;">
            <h3>Asistencias Registradas Hoy</h3>
            <button class="btn-danger" onclick="limpiarLista()">üóëÔ∏è Nueva Sesi√≥n</button>
        </div>

        <table id="tablaAsistencias">
            <thead>
                <tr>
                    <th>Hora</th>
                    <th>ID Alumno</th>
                    <th>Nombre</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody id="listaBody">
                </tbody>
        </table>
        
        <br>
        <button onclick="window.location.href='index.html'" style="padding:10px;">Cerrar Sesi√≥n</button>
    </div>

    <script>
        // Validar Rol Profesor
        const sesion = JSON.parse(localStorage.getItem('sesion'));
        if (!sesion || sesion.rol !== 'profesor') window.location.href = 'index.html';

        // [US-04] Persistencia: Cargar datos previos
        let listaAsistencia = JSON.parse(localStorage.getItem('db_asistencia')) || [];
        renderizarTabla();

        // Configuraci√≥n Esc√°ner [US-03]
        const scanner = new Html5Qrcode("reader");
        
        function onScanSuccess(decodedText) {
            try {
                const data = JSON.parse(decodedText);
                procesarRegistro(data);
            } catch (e) {
                mostrarAlerta("QR Inv√°lido o no pertenece al sistema", "error");
            }
        }

        function procesarRegistro(alumno) {
            const ahora = Date.now();

            // 1. [US-07] Validaci√≥n de Expiraci√≥n (15 mins = 900,000 ms)
            if (ahora - alumno.ts > 900000) {
                mostrarAlerta(`‚ùå El c√≥digo de ${alumno.nombre} expir√≥ hace ${(ahora - alumno.ts)/60000 | 0} min.`, "error");
                return;
            }

            // 2. [US-05] Anti-Fraude (Duplicados)
            const existe = listaAsistencia.find(r => r.uid === alumno.uid);
            if (existe) {
                mostrarAlerta(`‚ö†Ô∏è ${alumno.nombre} ya fue registrado a las ${existe.hora}`, "error");
                return;
            }

            // 3. Registro Exitoso
            const nuevoRegistro = {
                uid: alumno.uid,
                nombre: alumno.nombre,
                hora: new Date().toLocaleTimeString(),
                estado: "A Tiempo"
            };

            listaAsistencia.push(nuevoRegistro);
            localStorage.setItem('db_asistencia', JSON.stringify(listaAsistencia)); // Guardar
            
            renderizarTabla();
            mostrarAlerta(`‚úÖ Asistencia correcta: ${alumno.nombre}`, "success");
            
            // Pausa para evitar doble lectura instant√°nea
            scanner.pause();
            setTimeout(() => scanner.resume(), 2500);
        }

        function renderizarTabla() {
            const tbody = document.getElementById('listaBody');
            tbody.innerHTML = "";
            listaAsistencia.forEach(item => {
                tbody.innerHTML += `
                    <tr>
                        <td>${item.hora}</td>
                        <td>${item.uid}</td>
                        <td>${item.nombre}</td>
                        <td style="color:green; font-weight:bold;">${item.estado}</td>
                    </tr>
                `;
            });
        }

        function mostrarAlerta(msg, tipo) {
            const div = document.getElementById('statusMsg');
            div.innerText = msg;
            div.className = `alert ${tipo}`;
            div.style.display = 'block';
        }

        function limpiarLista() {
            if(confirm("¬øEst√°s seguro de iniciar una nueva clase? Se borrar√° la lista actual.")) {
                listaAsistencia = [];
                localStorage.removeItem('db_asistencia');
                renderizarTabla();
                mostrarAlerta("Lista reiniciada", "success");
            }
        }

        // Iniciar C√°mara
        scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);
    </script>
</body>
</html>
