<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Docente | Indaptados</title>
    <script src="html5-qrcode.min.js"></script>
    <style>
        :root { --sidebar: #0f172a; --bg: #f1f5f9; --primary: #2563eb; --text: #1e293b; --white: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 250px; background: var(--sidebar); color: white; display: flex; flex-direction: column; padding: 20px; }
        .logo { font-size: 1.5rem; font-weight: bold; margin-bottom: 40px; color: #60a5fa; display: flex; align-items: center; gap: 10px; }
        .menu-item { padding: 12px; border-radius: 8px; margin-bottom: 5px; cursor: pointer; transition: 0.2s; opacity: 0.7; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); opacity: 1; }
        .spacer { flex-grow: 1; }
        .btn-logout { background: transparent; border: 1px solid #ef4444; color: #ef4444; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-logout:hover { background: #ef4444; color: white; }

        /* MAIN CONTENT */
        .main { flex-grow: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        
        .top-header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .class-selector { padding: 10px; border-radius: 6px; border: 1px solid #cbd5e1; font-size: 1rem; min-width: 250px; background: #f8fafc; font-weight: 600; color: var(--text); }
        .clock { font-family: monospace; font-size: 1.2rem; font-weight: bold; color: var(--primary); background: #eff6ff; padding: 5px 15px; border-radius: 20px; }

        .dashboard-grid { display: grid; grid-template-columns: 350px 1fr; gap: 20px; height: 100%; }
        
        /* ESC√ÅNER */
        .scanner-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        #reader { width: 100%; border-radius: 8px; overflow: hidden; background: black; flex-grow: 1; }
        
        /* TABLA */
        .list-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden; display: flex; flex-direction: column; }
        .table-container { overflow-y: auto; flex-grow: 1; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; }
        thead { position: sticky; top: 0; background: white; }
        th { text-align: left; padding: 15px; border-bottom: 2px solid #f1f5f9; color: #64748b; font-size: 0.85rem; text-transform: uppercase; }
        td { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; font-size: 0.95rem; }
        tr:hover { background: #f8fafc; }
        
        /* ALERTAS TOAST */
        .toast { position: fixed; bottom: 30px; right: 30px; padding: 15px 25px; background: white; border-left: 5px solid; border-radius: 4px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); display: none; z-index: 1000; font-weight: 600; animation: slideIn 0.3s ease-out; }
        .toast-success { border-color: #10b981; color: #065f46; }
        .toast-error { border-color: #ef4444; color: #7f1d1d; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo">üè´ Indaptados</div>
        <div class="menu-item active">üì∏ Pase de Lista</div>
        <div class="menu-item">üìä Reportes</div>
        <div class="menu-item">‚öôÔ∏è Configuraci√≥n</div>
        <div class="spacer"></div>
        <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
    </div>

    <div class="main">
        <div class="top-header">
            <div>
                <div style="font-size: 0.85rem; color: #64748b;">Clase Actual</div>
                <select id="classSelector" class="class-selector" onchange="cambiarMateriaManual()">
                    <option value="">Seleccionando...</option>
                </select>
            </div>
            <div class="clock" id="reloj">00:00:00</div>
        </div>

        <div class="dashboard-grid">
            <div class="scanner-card">
                <h3 style="margin-top:0;">C√°mara</h3>
                <div id="reader"></div>
                <p style="text-align: center; color: #94a3b8; font-size: 0.9rem; margin-top: 10px;">Enfoque el QR del estudiante</p>
            </div>

            <div class="list-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin:0;">Asistencias Registradas</h3>
                    <span style="background: #e2e8f0; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold;" id="countBadge">0 Alumnos</span>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Hora</th>
                                <th>Matr√≠cula</th>
                                <th>Nombre</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="listaCuerpo">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Notificaci√≥n</div>

    <script>
        // 1. DATA: Horario Escolar Definido (7:00 a 1:10)
        const MATERIAS = [
            { id: 1, nombre: "C√°lculo Diferencial", start: 700, end: 750 },
            { id: 2, nombre: "Qu√≠mica Org√°nica", start: 750, end: 840 },
            { id: 3, nombre: "Programaci√≥n Estructurada", start: 840, end: 930 },
            { id: 4, nombre: "Base de Datos I", start: 930, end: 1020 },
            { id: 5, nombre: "Ingl√©s IV", start: 1020, end: 1110 },
            { id: 6, nombre: "Redes de Datos", start: 1110, end: 1200 },
            { id: 7, nombre: "√âtica Profesional", start: 1200, end: 1250 }
            // 12:50 - 13:10 Salida
        ];

        // 2. VERIFICACI√ìN DE SESI√ìN
        const sesion = JSON.parse(localStorage.getItem('sesion_escolar_v2'));
        if (!sesion || sesion.rol !== 'profesor') window.location.href = 'index.html';

        // 3. ESTADO
        let materiaActual = null;
        // Usamos una clave GLOBAL para que el alumno pueda leerla en su celular
        let dbGlobal = JSON.parse(localStorage.getItem('asistencias_global_db')) || [];

        // Llenar Dropdown
        const selector = document.getElementById('classSelector');
        MATERIAS.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m.nombre;
            opt.innerText = `${m.nombre} (${formatTime(m.start)} - ${formatTime(m.end)})`;
            selector.appendChild(opt);
        });

        // 4. L√ìGICA DE TIEMPO Y AUTO-SELECCI√ìN
        function formatTime(num) {
            // Convierte 750 a 07:50
            const str = num.toString().padStart(4, '0');
            return str.substring(0,2) + ":" + str.substring(2);
        }

        function updateClockAndClass() {
            const now = new Date();
            document.getElementById('reloj').innerText = now.toLocaleTimeString();
            
            const currentTime = (now.getHours() * 100) + now.getMinutes(); 

            // Buscar qu√© materia toca AHORA
            const claseToca = MATERIAS.find(m => currentTime >= m.start && currentTime < m.end);
            
            if (claseToca) {
                if (materiaActual !== claseToca.nombre) {
                    selector.value = claseToca.nombre;
                    materiaActual = claseToca.nombre;
                    renderTabla(); // Refrescar tabla para la nueva materia
                    mostrarToast(`Clase iniciada: ${materiaActual}`, 'success');
                }
            } else {
                // Fuera de horario o receso
                if(!materiaActual && selector.value === "") {
                    // Si no se ha seleccionado nada manual, dejar en blanco
                }
            }
        }
        setInterval(updateClockAndClass, 1000);
        updateClockAndClass(); // Run once

        function cambiarMateriaManual() {
            materiaActual = selector.value;
            renderTabla();
        }

        // 5. ESC√ÅNER
        const html5QrCode = new Html5Qrcode("reader");
        
        function onScanSuccess(decodedText) {
            if(!materiaActual) {
                mostrarToast("‚ö†Ô∏è Seleccione una materia o espere el horario", "error");
                return;
            }

            try {
                const alumno = JSON.parse(decodedText);
                procesarAsistencia(alumno);
            } catch (e) {
                mostrarToast("QR no reconocido", "error");
            }
        }

        function procesarAsistencia(alumno) {
            const ahora = Date.now();
            
            // A. Validar Expiraci√≥n (15 mins = 900,000 ms)
            if (ahora - alumno.ts > 900000) {
                mostrarToast(`‚ùå El c√≥digo de ${alumno.nombre} expir√≥`, "error");
                return;
            }

            const fechaHoy = new Date().toLocaleDateString();

            // B. Validar Duplicado GLOBAL (Misma materia, mismo d√≠a)
            const yaRegistrado = dbGlobal.find(r => 
                r.uid === alumno.uid && 
                r.materia === materiaActual && 
                r.fecha === fechaHoy
            );

            if (yaRegistrado) {
                mostrarToast(`‚ö†Ô∏è ${alumno.nombre} ya tiene asistencia`, "error");
                return;
            }

            // C. REGISTRAR
            const nuevoRegistro = {
                uid: alumno.uid,
                nombre: alumno.nombre,
                hora: new Date().toLocaleTimeString(),
                fecha: fechaHoy,
                materia: materiaActual,
                estado: 'Presente'
            };

            dbGlobal.push(nuevoRegistro);
            // Guardamos en la "Nube simulada" (LocalStorage compartido)
            localStorage.setItem('asistencias_global_db', JSON.stringify(dbGlobal));
            
            renderTabla();
            mostrarToast(`‚úÖ ${alumno.nombre} registrado`, "success");
            
            // Pausa para no leer doble
            html5QrCode.pause();
            setTimeout(() => html5QrCode.resume(), 2000);
        }

        function renderTabla() {
            const tbody = document.getElementById('listaCuerpo');
            tbody.innerHTML = '';
            
            const fechaHoy = new Date().toLocaleDateString();
            
            // Filtramos SOLO los de la materia actual y d√≠a actual
            const filtrados = dbGlobal.filter(r => r.materia === materiaActual && r.fecha === fechaHoy);
            
            // Actualizar contador
            document.getElementById('countBadge').innerText = `${filtrados.length} Alumnos`;

            // Llenar tabla (los m√°s recientes arriba)
            filtrados.reverse().forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-family:monospace;">${r.hora}</td>
                    <td>${r.uid}</td>
                    <td>${r.nombre}</td>
                    <td><span style="background:#dcfce7; color:#166534; padding:2px 8px; border-radius:10px; font-size:0.8rem; font-weight:bold;">${r.estado}</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function mostrarToast(msg, tipo) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.className = `toast toast-${tipo}`;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        function logout() {
            localStorage.removeItem('sesion_escolar_v2');
            window.location.href = 'index.html';
        }

        // Iniciar C√°mara
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);
    </script>
</body>
</html>