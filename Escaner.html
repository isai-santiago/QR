<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profesor - Escáner</title>
    <script src="html5-qrcode.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background-color: #f8f9fa; }
        h1 { text-align: center; }
        #reader { width: 100%; border-radius: 10px; overflow: hidden; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; text-align: center; display: none; font-weight: bold; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        
        /* Dashboard Tabla */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #007bff; color: white; }
        .btn-clear { background: #ff9800; color: white; border: none; padding: 5px 10px; margin-top: 10px; cursor: pointer; border-radius: 4px; }
    </style>
</head>
<body>

    <h1>Escáner de Asistencia</h1>
    
    <div id="reader"></div>

    <div id="statusMsg" class="status"></div>

    <h3>Registros de Hoy:</h3>
    <table id="tablaAsistencia">
        <thead>
            <tr>
                <th>Hora</th>
                <th>Matrícula</th>
                <th>Nombre</th>
            </tr>
        </thead>
        <tbody id="listaCuerpo">
            </tbody>
    </table>
    <button class="btn-clear" onclick="borrarHistorial()">Limpiar Lista</button>
    <br><br>
    <button onclick="window.location.href='index.html'">Cerrar Sesión</button>

    <script>
        // Verificar sesión de profesor
        const sesion = JSON.parse(localStorage.getItem('sesion_activa'));
        if (!sesion || sesion.rol !== 'profesor') window.location.href = 'index.html';

        // Cargar asistencias previas (Persistencia)
        let asistencias = JSON.parse(localStorage.getItem('asistencias_db')) || [];
        actualizarTabla();

        // Configuración del Escáner
        const html5QrCode = new Html5Qrcode("reader");
        
        function onScanSuccess(decodedText, decodedResult) {
            try {
                const datos = JSON.parse(decodedText);
                procesarAsistencia(datos);
            } catch (e) {
                mostrarMensaje("El QR no es válido o no pertenece al sistema", "error");
            }
        }

        function procesarAsistencia(alumno) {
            // [US-07] VALIDACIÓN DE EXPIRACIÓN (15 Minutos = 900,000 ms)
            const ahora = Date.now();
            if (ahora - alumno.timestamp > 900000) {
                mostrarMensaje(`❌ El QR de ${alumno.nombre} ha expirado. Genere uno nuevo.`, "error");
                return;
            }

            // [US-05] VALIDACIÓN ANTI-FRAUDE (Duplicados)
            const yaRegistrado = asistencias.find(a => a.uid === alumno.uid);
            if (yaRegistrado) {
                mostrarMensaje(`⚠️ ${alumno.nombre} ya fue registrado hoy a las ${yaRegistrado.hora}`, "error");
                return;
            }

            // Si pasa las validaciones, guardamos
            const nuevoRegistro = {
                uid: alumno.uid,
                nombre: alumno.nombre,
                hora: new Date().toLocaleTimeString()
            };

            asistencias.push(nuevoRegistro);
            localStorage.setItem('asistencias_db', JSON.stringify(asistencias)); // Guardar en BD local
            actualizarTabla();
            mostrarMensaje(`✅ Asistencia registrada: ${alumno.nombre}`, "success");
            
            // Pausa de 3 seg para no escanear múltiple veces por error
            html5QrCode.pause();
            setTimeout(() => { html5QrCode.resume(); }, 3000);
        }

        function mostrarMensaje(texto, tipo) {
            const msg = document.getElementById('statusMsg');
            msg.innerText = texto;
            msg.className = `status ${tipo}`;
            msg.style.display = 'block';
            
            // Sonido de confirmación (opcional)
            if(tipo === 'success') {
                let audio = new Audio('https://actions.google.com/sounds/v1/cartoon/pop.ogg'); 
                audio.play().catch(e => console.log("Audio play failed"));
            }
        }

        function actualizarTabla() {
            const tbody = document.getElementById('listaCuerpo');
            tbody.innerHTML = '';
            asistencias.forEach(reg => {
                const row = `<tr><td>${reg.hora}</td><td>${reg.uid}</td><td>${reg.nombre}</td></tr>`;
                tbody.innerHTML += row;
            });
        }

        function borrarHistorial() {
            if(confirm("¿Borrar toda la lista de hoy?")) {
                asistencias = [];
                localStorage.removeItem('asistencias_db');
                actualizarTabla();
            }
        }

        // Iniciar cámara
        html5QrCode.start(
            { facingMode: "environment" }, 
            { fps: 10, qrbox: 250 },
            onScanSuccess
        ).catch(err => {
            console.error("Error al iniciar cámara", err);
            mostrarMensaje("Error: No se pudo acceder a la cámara", "error");
        });
    </script>
</body>
</html>
